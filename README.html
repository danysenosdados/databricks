<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Pipeline ETL/ELT â€“ Transferegov</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
            color: #222;
        }
        h1, h2, h3 {
            color: #0A4C8C;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            color: #b30000;
            font-weight: bold;
        }
        .tag {
            background-color: #0A4C8C;
            padding: 4px 8px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>

<h1>ğŸ“¦ Pipeline ETL/ELT â€“ Transferegov</h1>
<p>
Este documento apresenta a arquitetura Bronze â†’ Silver â†’ Gold do pipeline de ingestÃ£o e transformaÃ§Ã£o dos dados da API oficial do <strong>Transferegov</strong>.  
A jornada Ã© simples: primeiro coletamos tudo, depois limpamos tudo, e por fim entregamos apenas o ouro.  
Cru e real. Sem fumaÃ§a. Sem vÃ©us. SÃ³ dados â€” tratados com respeito.
</p>

<hr>

<h2>ğŸš€ 1. Camada Bronze â€“ ExtraÃ§Ã£o</h2>
<p>
A Bronze Ã© o porÃ£o da casa: tudo chega como veio.  
Sem julgamento, sem maquiagem, sem tipagem.  
Cada endpoint Ã© extraÃ­do integralmente usando paginaÃ§Ã£o da API.
</p>

<h3>ğŸ“Œ Scripts</h3>
<p class="tag">bronze_transferegov_extract.py</p>

<pre><code>
- Realiza GET paginado em todos os endpoints da API.
- Normaliza estruturas (dict/list â†’ JSON string).
- MantÃ©m todas as colunas originais como STRING.
- Cria data_atualizacao com current_timestamp().
- Armazena cada tabela em: bronze.transferegov.&lt;endpoint&gt;
</code></pre>

<h3>ğŸ“Œ Endpoints coletados</h3>
<pre><code>
plano_acao
plano_acao_analise
plano_acao_analise_responsavel
plano_acao_dado_bancario
plano_acao_destinacao_recursos
plano_acao_historico
plano_acao_meta
plano_acao_meta_acao
programa
programa_beneficiario
programa_gestao_agil
relatorio_gestao
relatorio_gestao_acoes
relatorio_gestao_analise
relatorio_gestao_analise_responsavel
termo_adesao
</code></pre>

<hr>

<h2>âœ¨ 2. Camada Silver â€“ TransformaÃ§Ã£o</h2>
<p>
A Silver Ã© onde a sujeira vira forma.  
Nomes de colunas sÃ£o domesticados.  
Tipos sÃ£o inferidos com carinho â€” e convertidos com rigor.
</p>

<p class="tag">silver_transferegov_clean_cast.py</p>

<h3>ğŸ“Œ Principais regras</h3>
<pre><code>
- NormalizaÃ§Ã£o de nomes: snake_case.
- InferÃªncia de tipos usando amostragem (int, double, date, timestamp).
- Tratamento de vÃ­rgulas em nÃºmeros decimais.
- ConversÃ£o segura (try_cast).
- Escrita final: silver.transferegov.&lt;endpoint&gt;
</code></pre>

<hr>

<h2>ğŸ† 3. Camada Gold â€“ SeleÃ§Ã£o e Relacionamento</h2>
<p>
Aqui Ã© onde a histÃ³ria encontra propÃ³sito.  
SÃ³ fica o que importa.  
O resto vai embora sem choro.
</p>

<h3>ğŸ’° 3.1 Filtragem por CNPJ (plano_acao + programa_beneficiario)</h3>

<p>
Ambas tabelas podem â€” e devem â€” usar um script Ãºnico, apenas mudando:
</p>

<ul>
    <li>nome da tabela base</li>
    <li>nome da coluna filtrada</li>
</ul>

<p class="tag">gold_filter_cnpj.py (recomendado)</p>

<pre><code>
- Filtra tabelas Silver usando CNPJs presentes nas tabelas Gold base.
- Cria automaticamente gold.transferegov.&lt;endpoint&gt; filtradas.
</code></pre>

<hr>

<h3>ğŸ§© 3.2 Joins com id_plano_acao</h3>
<p class="tag">gold_join_plano_acao.py</p>

<pre><code>
id_plano_acao â†’ INNER JOIN

Endpoints relacionados:
- plano_acao_analise
- plano_acao_dado_bancario
- plano_acao_destinacao_recursos
- plano_acao_historico
- plano_acao_meta
- relatorio_gestao
- termo_adesao
</code></pre>

<hr>

<h3>ğŸ§© 3.3 Join aninhado (plano_acao_analise â†’ responsavel)</h3>

<p class="tag">gold_plano_acao_analise_responsavel.py</p>

<pre><code>
JOIN:
gold.plano_acao_analise.id_analise_plano_acao 
    == silver.plano_acao_analise_responsavel.plano_acao_analise_fk
</code></pre>

<hr>

<h3>ğŸ§© 3.4 Join aninhado (plano_acao_meta â†’ meta_acao)</h3>

<p class="tag">gold_plano_acao_meta_acao.py</p>

<pre><code>
JOIN:
gold.plano_acao_meta.id_meta_plano_acao
    == silver.plano_acao_meta_acao.id_meta_plano_acao
</code></pre>

<hr>

<h3>ğŸ§© 3.5 Joins de RelatÃ³rio de GestÃ£o</h3>

<p class="tag">gold_relatorio_gestao.py</p>

<pre><code>
id_relatorio_gestao â†’ INNER JOIN

Endpoints relacionados:
- relatorio_gestao_acoes
- relatorio_gestao_analise
</code></pre>

<hr>

<h2>ğŸ Resultado Final</h2>
<p>
O pipeline entrega uma malha Gold racional, enxuta e preparada para BI, dashboards e anÃ¡lises avanÃ§adas.  
O ETL termina limpo, honesto e sem frescura.
</p>

<hr>

<h2>ğŸ›  ExecuÃ§Ã£o</h2>

<p>Para acionar o pipeline completo dentro do Databricks:</p>

<pre><code>
1. Executar Bronze
2. Executar Silver
3. Executar Gold (todos)
</code></pre>

<p>E pronto: o ouro brilha sozinho.</p>

<hr>

<h2>âœ‰ Contato</h2>
<p>Para dÃºvidas, cafÃ© ou poesia sobre dados, procure o responsÃ¡vel pelo pipeline.</p>

</body>
</html>
